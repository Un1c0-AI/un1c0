name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-test:
    runs-on: ubuntu-latest
    env:
      GO_VERSION: '1.21'
      ZIG_VERSION: '0.12.1'
    steps:
      - uses: actions/checkout@v4
      - name: Enforce MASTER_KEY presence
        # This step ensures the repository secret MASTER_KEY is set. Secrets are not
        # exposed to workflows from forks; this causes CI to fail on forked PRs.
        run: |
          set -e
          if [ -z "${{ secrets.MASTER_KEY }}" ]; then
            echo "ERROR: MASTER_KEY secret is not configured for this repository."
            echo "CI requires a MASTER_KEY to run. To obtain a master key, follow the project SECURITY policy.";
            exit 1
          fi
      - name: Setup Rust
        uses: dtolnay/setup-rust@v1
        with:
          toolchain: stable
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: Install Zig from release tarball
        run: |
          set -eux
          Z=${ZIG_VERSION}
          ARCH=zig-linux-x86_64
          URL="https://github.com/ziglang/zig/releases/download/${Z}/${ARCH}-${Z}.tar.xz"
          echo "Downloading Zig from $URL"
          curl -sSLo /tmp/zig.tar.xz "$URL"
          sudo mkdir -p /opt/zig
          sudo tar -xJ -C /opt -f /tmp/zig.tar.xz
          # Symlink the zig binary into PATH
          sudo ln -sf /opt/${ARCH}-${Z}/zig /usr/local/bin/zig
          zig version
      - name: Check & apply formatting: gofmt
        env:
          GIT_AUTHOR_NAME: github-actions
          GIT_AUTHOR_EMAIL: actions@github.com
        run: |
          set -eux
          # List files that would be reformatted under -s simplifications
          OUT=$(gofmt -s -l . || true)
          if [ -n "$OUT" ]; then
            echo "gofmt -s will reformat these files:";
            echo "$OUT";
            echo "Applying gofmt -s -w .";
            gofmt -s -w .;
            git config user.name "$GIT_AUTHOR_NAME";
            git config user.email "$GIT_AUTHOR_EMAIL";
            git add -A;
            if git diff --cached --quiet; then
              echo "No changes to commit after formatting.";
            else
              git commit -m "chore: apply gofmt -s formatting [skip ci]" || true;
              # Only attempt to push if this run has permission (not a forked PR)
              if [ "${GITHUB_EVENT_NAME:-}" = "pull_request" ]; then
                HEAD_REPO_FULL_NAME="${{ github.event.pull_request.head.repo.full_name }}"
                if [ "$HEAD_REPO_FULL_NAME" != "${{ github.repository }}" ]; then
                  echo "Refusing to push formatting commit for forked PR (head repo: $HEAD_REPO_FULL_NAME).";
                else
                  git push origin HEAD:${{ github.ref_name }} || true;
                fi
              else
                git push origin HEAD:${{ github.ref_name }} || true;
              fi
            fi
          else
            echo "gofmt reports no changes.";
          fi
      - name: Check & apply formatting: zig fmt
        env:
          GIT_AUTHOR_NAME: github-actions
          GIT_AUTHOR_EMAIL: actions@github.com
        run: |
          set -eux
          FILES=$(git ls-files '*.zig' || true)
          if [ -n "$FILES" ]; then
            echo "Running zig fmt on tracked .zig files";
            zig fmt $FILES || true
            git config user.name "$GIT_AUTHOR_NAME";
            git config user.email "$GIT_AUTHOR_EMAIL";
            git add -A;
            if git diff --cached --quiet; then
              echo "No changes to commit after zig fmt.";
            else
              git commit -m "chore: apply zig fmt formatting [skip ci]" || true;
              if [ "${GITHUB_EVENT_NAME:-}" = "pull_request" ]; then
                HEAD_REPO_FULL_NAME="${{ github.event.pull_request.head.repo.full_name }}"
                if [ "$HEAD_REPO_FULL_NAME" != "${{ github.repository }}" ]; then
                  echo "Refusing to push zig formatting commit for forked PR (head repo: $HEAD_REPO_FULL_NAME).";
                else
                  git push origin HEAD:${{ github.ref_name }} || true;
                fi
              else
                git push origin HEAD:${{ github.ref_name }} || true;
              fi
            fi
          else
            echo "No .zig files tracked; skipping zig fmt run.";
          fi

      - name: Run go vet and go build (if applicable)
        run: |
          set -eux
          # Run vet and build for any Go packages in the repository
          if go list ./... >/dev/null 2>&1; then
            go vet ./... || (echo "go vet failed"; exit 1)
            go build ./... || (echo "go build failed"; exit 1)
          else
            echo "No Go packages to vet/build; skipping.";
          fi

      - name: Attempt to build tracked .zig files
        run: |
          set -eux
          FILES=$(git ls-files '*.zig' || true)
          if [ -n "$FILES" ]; then
            echo "Attempting to build each tracked .zig file with 'zig build-exe' to detect obvious compile errors.";
            FAIL=0
            for f in $FILES; do
              echo "Building $f";
              # Build to a temp output to avoid clobbering repository
              OUTBIN=$(mktemp -u /tmp/zig-bin-XXXX)
              if ! zig build-exe "$f" -O ReleaseSmall -femit-bin="$OUTBIN" >/dev/null 2>&1; then
                echo "zig failed to build $f";
                FAIL=1
              else
                rm -f "$OUTBIN" || true
              fi
            done
            if [ "$FAIL" -ne 0 ]; then
              echo "One or more .zig files failed to compile.";
              exit 1
            fi
          else
            echo "No .zig files tracked; skipping zig build-exe checks.";
          fi
      - name: Run cargo test
        run: cargo test --all -- --nocapture
      - name: Show generated examples
        run: |
          if [ -d examples/generated ]; then ls -R examples/generated || true; fi
